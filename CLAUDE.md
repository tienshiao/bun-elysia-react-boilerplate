# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

- **Dev server:** `bun run dev` (runs on http://localhost:4000 with watch mode and HMR)
- **Build (current platform):** `bun run build:server` (outputs to `dist-executables/server`)
- **Build (all platforms):** `bun run build:server:all` (macOS x64/ARM64, Linux x64, Windows x64)
- **Run tests:** `bun test` (uses Bun's built-in test runner)
- **Run single test:** `bun test src/modules/auth/auth.test.ts`
- **Generate migrations:** `bunx drizzle-kit generate` (outputs to `drizzle/`)
- **Lint + format check:** `bun run check` (runs Prettier check then ESLint)
- **Lint + format fix:** `bun run fix` (runs Prettier write then ESLint --fix)

## Architecture

Full-stack monolithic app: Elysia backend serves a React 19 SPA, all running on Bun.

**Backend** (`src/index.ts`): Elysia server with middleware chain (logger → helmet → openapi). All API routes are grouped under `/api` via `makeApiPlugin` (`src/api.ts`), which wires up the database, JWT, auth guard, and role-based access. Non-API routes proxy to the SPA HTML. The server exports an `App` type used by the frontend for type-safe API calls via Eden Treaty.

**Frontend** (`src/frontend/index.html`, `src/frontend/`): React 19 app bundled by Bun with `bun-plugin-tailwind`. The HTML template imports `frontend.tsx` as a module, which Bun transpiles and serves.

**SPA Proxy pattern**: The HTML is served through a UUID-based internal route (`/{randomUUID}`) so that all requests pass through Elysia's middleware stack (logging, security headers). A catch-all `/*` route proxies non-API requests to this internal route. This works around Bun's static file serving which would otherwise bypass middleware.

**Database** (`src/db/`): PostgreSQL via `postgres` (postgres.js) driver + Drizzle ORM. Schema definitions live in `src/db/schema/`. Migrations are in `drizzle/` and generated by drizzle-kit. `makeDb(config.db)` creates the drizzle instance.

**Auth module** (`src/modules/auth/`): JWT-based authentication with sign-up, sign-in, sign-out, and token refresh. Uses ES256 (ECDSA) JWTs with separate auth/refresh token types. Auth guard (`makeAuthGuard`) protects routes. Role-based authorization (`src/modules/auth/roles.ts`) uses static `Role` classes (e.g., `AdminRole`, `AuthenticatedRole`, `UserOwnerRole`) resolved via `makeAllowRoles()`. Dependencies (db, jwt) are injected via factory functions — no direct `process.env` access in module code.

**Users module** (`src/modules/users/`): User profile CRUD (get, update). Routes are role-protected — read requires `AuthenticatedRole`, update requires `AdminRole` or `UserOwnerRole`.

**Short UUIDs** (`src/db/short-uuid.ts`): Bidirectional conversion between standard UUIDs and compact 22-character base57 strings. A Drizzle custom type (`shortUuid`) auto-converts at the driver level. All user-facing IDs use the short format; accepts either format as input.

**Config** (`src/config.ts`): Typed config via TypeBox schema. Reads from env vars (`DATABASE_URL`, `JWT_PRIVATE_KEY`, `JWT_PUBLIC_KEY`, `PORT`) with defaults. JWT keys can also be loaded from `keys/private.pem` and `keys/public.pem`.

**Build system** (`build-single.ts`, `build-all.ts`): Compiles the entire app into standalone executables using Bun's compile API. Embeds version info and git hash, sets production env, and minifies output.

## Key Conventions

- **Runtime:** Bun (not Node.js) — use `bun` for all commands
- **Path alias:** `@/*` maps to `src/*` (configured in tsconfig.json)
- **Linting:** ESLint (flat config, `eslint.config.js`) with `typescript-eslint`, `react-hooks`, `react-refresh`, and `simple-import-sort`. Prettier handles formatting via `eslint-config-prettier` to avoid conflicts.
- **Formatting:** Prettier with double quotes, semicolons, trailing commas, 100 print width, LF. Run `bun run fix` to auto-fix both. Config in `.prettierrc`.
- **TypeScript:** Strict mode, `react-jsx` transform, bundler module resolution
- **Dependency injection:** Modules use factory functions (e.g., `makeAuthPlugin(db, jwt)`) that receive config/dependencies as arguments. Do not read `process.env` or `import.meta` inside module code — all config flows through `loadConfig()` and is passed explicitly.
- **Testing:** Use Elysia's `.handle()` method to test routes without starting the server (see `src/modules/auth/auth.test.ts` for pattern)
- **Test DB isolation:** Use `makeTestDb(config.db, schemaName)` from `src/db/test-helpers.ts` to get a per-test-file PostgreSQL schema. Each test file uses a unique schema name (e.g., `'auth'`), which gets prefixed with `test_` automatically. The factory drops/recreates the schema and runs migrations with `"public".` qualifiers stripped. Schemas are left intact after tests for debugging. No `afterAll` cleanup needed.
